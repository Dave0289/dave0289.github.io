<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Common Scents ‚Ä¢ Menu</title>

  <style>
    /* =========================
       MOBILE HORIZONTAL FIXES
       ========================= */
    html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
    *, *::before, *::after { box-sizing: border-box; }
    img, svg, video, canvas { max-width: 100%; height: auto; display: block; }
    .overflow-clip { overflow-x: clip; }

    /* =========================
       THEME
       ========================= */
    :root{
      --bg: #070605;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.88);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);
      --gold: rgba(214, 172, 85, .95);
      --gold2: rgba(214, 172, 85, .55);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    body{
      margin: 0;
      background:
        radial-gradient(1200px 600px at 25% 18%, rgba(214,172,85,.12), rgba(0,0,0,0) 60%),
        radial-gradient(900px 520px at 72% 30%, rgba(255,255,255,.05), rgba(0,0,0,0) 58%),
        var(--bg);
      color: var(--text);
      font-family: var(--sans);
      letter-spacing: .2px;
    }

    /* =========================
       HEADER / NAV
       ========================= */
    .site-header{
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(7,6,5,.78);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .nav-wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      min-width: 0;
    }

    .brand{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text);
      min-width: 0;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 60% 70%, rgba(214,172,85,.95), rgba(214,172,85,0) 60%),
        rgba(214,172,85,.35);
      box-shadow: 0 0 18px rgba(214,172,85,.25);
      flex: 0 0 auto;
    }
    .brand-title{
      display: grid;
      line-height: 1.05;
      min-width: 0;
    }
    .brand-title strong{
      font-family: var(--serif);
      letter-spacing: .18em;
      font-size: 12px;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .brand-title span{
      font-size: 11px;
      letter-spacing: .28em;
      opacity: .70;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .nav-links{
      display: flex;
      align-items: center;
      gap: 18px;
      min-width: 0;
    }
    .nav-links a{
      text-decoration: none;
      color: var(--muted);
      font-weight: 650;
      font-size: 12px;
      letter-spacing: .28em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .nav-links a:hover{ color: var(--text); }

    .nav-actions{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .btn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      height: 38px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      text-decoration: none;
      font-weight: 700;
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    .btn:hover{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); }
    .btn.gold{ border-color: rgba(214,172,85,.38); box-shadow: 0 0 0 1px rgba(214,172,85,.12) inset; }
    .icon-btn{ width: 40px; padding: 0; position: relative; }

    /* Cart badge on icon */
    .cart-badge{
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      display: none; /* only show when > 0 */
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .04em;
      color: rgba(0,0,0,.88);
      background: rgba(214,172,85,.95);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.28);
      line-height: 1;
      pointer-events: none;
    }

    .nav-toggle{ display: none; }

    .drawer{
      display: none;
      border-top: 1px solid rgba(255,255,255,.06);
      background: rgba(7,6,5,.92);
      padding: 10px 16px 16px;
    }
    .drawer a{
      display: block;
      padding: 12px 10px;
      border-radius: 14px;
      text-decoration: none;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .20em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .drawer a:hover{ background: rgba(255,255,255,.04); color: var(--text); }

    @media (max-width: 860px){
      .nav-links{ display: none; }
      .nav-toggle{ display: inline-flex; }
      body.nav-open .drawer{ display: block; }
    }

    /* =========================
       PAGE
       ========================= */
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 40px 16px 80px;
      min-width: 0;
    }

    .hero{
      display: grid;
      gap: 16px;
      max-width: 860px;
      padding-top: 18px;
      min-width: 0;
    }

    h1{
      font-family: var(--serif);
      letter-spacing: .42em;
      text-transform: uppercase;
      font-weight: 500;
      margin: 0;
      font-size: clamp(34px, 6vw, 64px);
    }

    .sub{
      margin: 0;
      color: var(--muted);
      max-width: 64ch;
      font-size: 14px;
      line-height: 1.6;
    }

    .pills{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
      min-width: 0;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.72);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* =========================
       MENU PANEL
       ========================= */
    .panel{
      margin-top: 18px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 420px at 22% 0%, rgba(214,172,85,.14), rgba(0,0,0,0) 60%),
        rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-width: 0;
    }

    .panel-top{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
      min-width: 0;
    }

    .panel-top > div{
      padding: 18px 22px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 14px;
      min-width: 0;
    }

    .panel-title{
      font-family: var(--serif);
      letter-spacing: .24em;
      text-transform: uppercase;
      font-size: 16px;
      margin: 0;
      white-space: nowrap;
    }

    .panel-meta{
      color: var(--muted2);
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .menu-grid{
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 0;
      min-width: 0;
    }

    .left{
      padding: 18px 18px 22px;
      border-right: 1px solid rgba(255,255,255,.08);
      min-width: 0;
    }

    .right{
      padding: 18px 18px 22px;
      min-width: 0;
    }

    @media (max-width: 860px){
      .panel-top{ grid-template-columns: 1fr; }
      .panel-top > div{ border-bottom: 1px solid rgba(255,255,255,.08); }
      .panel-top > div:last-child{ border-bottom: none; }
      .menu-grid{ grid-template-columns: 1fr; }
      .left{ border-right: none; border-bottom: 1px solid rgba(255,255,255,.08); }
    }

    /* =========================
       SCENT CARDS
       ========================= */
    .card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius2);
      padding: 14px 14px;
      margin: 12px 0;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      min-width: 0;
    }

    .card h3{
      margin: 0;
      font-family: var(--serif);
      letter-spacing: .18em;
      text-transform: uppercase;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card p{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .price{
      color: var(--gold);
      font-weight: 800;
      letter-spacing: .16em;
      font-size: 12px;
      text-transform: uppercase;
      white-space: nowrap;
      margin-top: 2px;
      text-align: right;
    }

    .controls{
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
      min-width: 0;
    }

    .qty{
      display: inline-flex;
      align-items: center;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      overflow: hidden;
      height: 38px;
      flex: 0 0 auto;
    }
    .qty button{
      width: 38px;
      height: 38px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,.80);
      font-size: 18px;
      cursor: pointer;
    }
    .qty span{
      width: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: rgba(255,255,255,.86);
      font-size: 12px;
      letter-spacing: .10em;
    }

    .add{
      height: 38px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(214,172,85,.38);
      background: rgba(214,172,85,.08);
      color: rgba(255,255,255,.92);
      font-weight: 850;
      letter-spacing: .22em;
      text-transform: uppercase;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }
    .add:hover{ background: rgba(214,172,85,.12); }

    /* Right panel */
    .note{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius2);
      padding: 16px;
      margin-top: 10px;
    }
    .note h4{
      margin: 0 0 8px;
      font-family: var(--serif);
      letter-spacing: .20em;
      text-transform: uppercase;
      font-size: 13px;
    }
    .note p{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }
    .fine{
      margin-top: 12px;
      color: rgba(255,255,255,.46);
      font-size: 11px;
      letter-spacing: .20em;
      text-transform: uppercase;
      line-height: 1.6;
    }

    .mini-cart{
      margin-top: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius2);
      padding: 14px 16px;
    }
    .mini-cart .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      color: rgba(255,255,255,.78);
      font-size: 12px;
      letter-spacing: .18em;
      text-transform: uppercase;
      margin: 8px 0;
      min-width: 0;
    }
    .mini-cart .total{
      color: rgba(255,255,255,.92);
      font-weight: 900;
    }
    .mini-cart .hint{
      margin-top: 10px;
      color: rgba(255,255,255,.50);
      font-size: 12px;
      line-height: 1.5;
      letter-spacing: .02em;
      text-transform: none;
    }

    @media (max-width: 520px){
      .card{ grid-template-columns: 1fr; }
      .price{ text-align: left; margin-top: 10px; }
      .controls{ justify-content: flex-start; }
    }

    /* =========================
       CART DRAWER
       ========================= */
    .cart-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      z-index: 2000;
    }
    body.cart-open .cart-overlay{ display: block; }

    .cart-drawer{
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(420px, 92vw);
      background: rgba(7,6,5,.96);
      backdrop-filter: blur(14px);
      border-left: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      transform: translateX(110%);
      transition: transform .24s ease;
      z-index: 2100;
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-width: 0;
    }
    body.cart-open .cart-drawer{ transform: translateX(0); }

    .cart-head{
      padding: 16px 16px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      min-width: 0;
    }
    .cart-head h2{
      margin: 0;
      font-family: var(--serif);
      letter-spacing: .20em;
      text-transform: uppercase;
      font-weight: 500;
      font-size: 16px;
    }
    .cart-close{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.88);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }

    .cart-body{
      overflow: auto;
      padding: 14px 16px 0;
      min-width: 0;
    }

    .cart-item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px 12px;
      margin: 10px 0;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      min-width: 0;
    }
    .cart-item strong{
      display:block;
      font-family: var(--serif);
      letter-spacing: .14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.90);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cart-item small{
      display:block;
      margin-top: 6px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      letter-spacing: .02em;
      text-transform: none;
      line-height: 1.4;
    }
    .cart-item .line{
      color: var(--gold);
      font-weight: 800;
      letter-spacing: .12em;
      font-size: 12px;
      text-transform: uppercase;
      white-space: nowrap;
      text-align: right;
    }

    .cart-foot{
      border-top: 1px solid rgba(255,255,255,.08);
      padding: 12px 16px 16px;
      display: grid;
      gap: 10px;
      min-width: 0;
    }
    .cart-summary{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      color: rgba(255,255,255,.80);
      letter-spacing: .16em;
      text-transform: uppercase;
      font-size: 11px;
      min-width: 0;
    }
    .cart-summary b{ color: rgba(255,255,255,.92); }

    .checkout{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px;
      display: grid;
      gap: 10px;
      min-width: 0;
    }

    .field{
      display:grid;
      gap: 6px;
    }
    .field label{
      color: rgba(255,255,255,.60);
      font-size: 10px;
      letter-spacing: .22em;
      text-transform: uppercase;
    }
    .field input, .field textarea{
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.88);
      padding: 10px 12px;
      font-family: var(--sans);
      font-size: 13px;
      outline: none;
    }
    .field textarea{ min-height: 70px; resize: vertical; }

    .cta-row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .cta{
      flex: 1 1 160px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(214,172,85,.38);
      background: rgba(214,172,85,.10);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      letter-spacing: .22em;
      text-transform: uppercase;
      font-size: 11px;
      cursor: pointer;
    }
    .cta:hover{ background: rgba(214,172,85,.14); }

    .cta.secondary{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-weight: 800;
    }

    .status{
      color: rgba(255,255,255,.62);
      font-size: 12px;
      line-height: 1.4;
      letter-spacing: .02em;
      text-transform: none;
    }
    .status.ok{ color: rgba(214,172,85,.95); }
    .status.err{ color: rgba(255,120,120,.92); }
  </style>
</head>

<body class="overflow-clip">
  <header class="site-header">
    <div class="nav-wrap">
      <a class="brand" href="./index.html" aria-label="Common Scents Home">
        <span class="dot" aria-hidden="true"></span>
        <span class="brand-title">
          <strong>COMMON SCENTS</strong>
          <span>MENU</span>
        </span>
      </a>

      <nav class="nav-links" aria-label="Primary">
        <a href="./index.html">Home</a>
        <a href="./menu.html" style="color: var(--text);">Wax Melts</a>
        <a href="./menu.html#candles">Candles</a>
      </nav>

      <div class="nav-actions">
        <a class="btn gold" href="./index.html#notify">Notify Me</a>

        <!-- Cart icon with badge -->
        <button class="btn icon-btn" id="openCartBtn" type="button" aria-label="Cart">
          üõí
          <span class="cart-badge" id="cartBadge" aria-hidden="true">0</span>
        </button>

        <button class="btn nav-toggle" id="navToggle" type="button" aria-label="Menu">‚ò∞</button>
      </div>
    </div>

    <div class="drawer" id="drawer" aria-label="Mobile Menu">
      <a href="./index.html">Home</a>
      <a href="./menu.html">Wax Melts</a>
      <a href="./menu.html#candles">Candles</a>
      <a href="./index.html#notify">Notify Me</a>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1>THE MENU</h1>
      <p class="sub">
        A luxury selection built for warm rooms and slow evenings. Start with wax melts today‚Äî
        candles arrive next.
      </p>

      <div class="pills" aria-label="Specs">
        <span class="pill">Wax melts ‚Ä¢ 6 per clamshell</span>
        <span class="pill">Total weight ‚Ä¢ 12.6 oz</span>
        <span class="pill" id="pricePill">$5.00 each ‚Ä¢ + shipping & handling</span>
      </div>
    </section>

    <section class="panel" aria-label="Menu Panel">
      <div class="panel-top">
        <div>
          <p class="panel-title">WAX MELTS</p>
          <p class="panel-meta" id="panelMeta">$5.00 / clamshell ‚Ä¢ 6 melts ‚Ä¢ 12.6 oz</p>
        </div>
        <div id="candles">
          <p class="panel-title">CANDLES</p>
          <p class="panel-meta">Coming soon ‚Ä¢ Same signature scents</p>
        </div>
      </div>

      <div class="menu-grid">
        <div class="left">
          <div id="scentList"></div>
        </div>

        <aside class="right">
          <div class="note">
            <h4>CANDLES ARE COMING NEXT</h4>
            <p>
              We‚Äôre launching wax melts first. Candle pours will follow in these same
              signature fragrances‚Äîwith the same luxury finish as the main page.
            </p>
            <p style="margin-top:10px;">
              Want first access? Tap <strong>‚ÄúNotify Me‚Äù</strong> and we‚Äôll send the launch drop.
            </p>
          </div>

          <div class="mini-cart" id="cart">
            <div class="row">
              <span>Items</span>
              <span id="cartItems">0</span>
            </div>
            <div class="row total">
              <span>Est. Subtotal</span>
              <span id="cartTotal">$0.00</span>
            </div>
            <div class="hint">
              This is a ‚Äúbuild your list‚Äù cart for now‚Äîonline checkout opens soon.
            </div>
          </div>

          <div class="fine">
            Online ordering will open soon. The cart on this page is for selecting
            quantities and building your list.
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- CART OVERLAY + DRAWER -->
  <div class="cart-overlay" id="cartOverlay" aria-hidden="true"></div>

  <aside class="cart-drawer" id="cartDrawer" aria-label="Cart Drawer" aria-hidden="true">
    <div class="cart-head">
      <h2>Your Cart</h2>
      <button class="cart-close" id="closeCartBtn" type="button" aria-label="Close cart">‚úï</button>
    </div>

    <div class="cart-body">
      <div id="cartList"></div>
      <div class="status" id="emptyMsg" style="margin:12px 0; display:none;">
        Your cart is empty. Add a few scents from the menu.
      </div>
    </div>

    <div class="cart-foot">
      <div class="cart-summary">
        <span>Items</span>
        <b id="drawerItems">0</b>
      </div>
      <div class="cart-summary">
        <span>Subtotal</span>
        <b id="drawerSubtotal">$0.00</b>
      </div>
      <div class="cart-summary">
        <span>Shipping</span>
        <b id="drawerShipping">$0.00</b>
      </div>
      <div class="cart-summary">
        <span>Total</span>
        <b id="drawerTotal">$0.00</b>
      </div>

      <div class="checkout">
        <div class="field">
          <label for="custName">Name</label>
          <input id="custName" type="text" autocomplete="name" placeholder="Your name" />
        </div>
        <div class="field">
          <label for="custEmail">Email</label>
          <input id="custEmail" type="email" autocomplete="email" placeholder="you@email.com" />
        </div>
        <div class="field">
          <label for="custPhone">Phone (optional)</label>
          <input id="custPhone" type="tel" autocomplete="tel" placeholder="(555) 123-4567" />
        </div>
        <div class="field">
          <label for="custNotes">Notes (pickup/shipping, etc.)</label>
          <textarea id="custNotes" placeholder="Pickup at market / shipping address / anything you want us to know"></textarea>
        </div>

        <div class="cta-row">
          <button class="cta secondary" id="continueBtn" type="button">Go Back</button>
          <button class="cta secondary" id="copyJsonBtn" type="button">Copy JSON</button>
          <button class="cta" id="placeOrderBtn" type="button">Checkout</button>
        </div>

        <div class="status" id="orderStatus">Orders send by email (no payment yet).</div>
      </div>
    </div>
  </aside>

  <!-- EmailJS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script>
    /***********************
     * CONFIG
     ***********************/
    // EmailJS: set these when you‚Äôre ready (works on GitHub Pages)
    const EMAILJS = {
      enabled: false,
      publicKey: "",
      serviceId: "",
      templateId: "",
      toEmail: "commonscentsusa@yahoo.com" // ‚úÖ orders go here
    };

    const CART_KEY = "commonScentsCart_v1";

    // Loaded from products.json
    let CURRENCY = "USD";
    let UNIT_PRICE = 5.00;
    let SHIPPING = {
      mode: "flat_plus_per_item",
      base: 6.95,
      per_item: 0.75,
      free_over: 75.00,
      label: "Shipping & Handling"
    };

    let SCENTS = [];

    // cart map: key -> { sku, name, price, qty }
    const cart = new Map();

    /***********************
     * DOM
     ***********************/
    const listEl = document.getElementById("scentList");
    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");

    const drawerItemsEl = document.getElementById("drawerItems");
    const drawerSubtotalEl = document.getElementById("drawerSubtotal");
    const drawerShippingEl = document.getElementById("drawerShipping");
    const drawerTotalEl = document.getElementById("drawerTotal");

    const pricePillEl = document.getElementById("pricePill");
    const panelMetaEl = document.getElementById("panelMeta");

    const openCartBtn = document.getElementById("openCartBtn");
    const closeCartBtn = document.getElementById("closeCartBtn");
    const cartOverlay = document.getElementById("cartOverlay");
    const cartDrawer = document.getElementById("cartDrawer");

    const cartListEl = document.getElementById("cartList");
    const emptyMsgEl = document.getElementById("emptyMsg");

    const custNameEl = document.getElementById("custName");
    const custEmailEl = document.getElementById("custEmail");
    const custPhoneEl = document.getElementById("custPhone");
    const custNotesEl = document.getElementById("custNotes");

    const continueBtn = document.getElementById("continueBtn");
    const copyJsonBtn = document.getElementById("copyJsonBtn");
    const placeOrderBtn = document.getElementById("placeOrderBtn");
    const orderStatusEl = document.getElementById("orderStatus");

    const cartBadgeEl = document.getElementById("cartBadge");

    /***********************
     * UTILS
     ***********************/
    function money(n){ return `$${Number(n || 0).toFixed(2)}`; }

    function safeIdFromName(name){
      return String(name || "")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function nowISO(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,"0");
      const tz = -d.getTimezoneOffset();
      const sign = tz >= 0 ? "+" : "-";
      const hh = pad(Math.floor(Math.abs(tz)/60));
      const mm = pad(Math.abs(tz)%60);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${hh}:${mm}`;
    }

    function genOrderId(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,"0");
      const stamp = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      const rand = Math.random().toString(16).slice(2,6).toUpperCase();
      return `CS-${stamp}-${rand}`;
    }

    function setStatus(msg, kind=""){
      orderStatusEl.classList.remove("ok","err");
      if (kind) orderStatusEl.classList.add(kind);
      orderStatusEl.textContent = msg;
    }

    /***********************
     * PRODUCTS.JSON LOADING
     ***********************/
    function normalizeScent(obj){
      const name = obj?.name || "";
      const blurb = obj?.blurb || "";
      const sku = obj?.id || obj?.sku || safeIdFromName(name);
      return { sku, name, blurb, price: UNIT_PRICE };
    }

    async function loadProducts(){
      const res = await fetch("./products.json", { cache: "no-store" });
      if(!res.ok) throw new Error("products.json not found");
      const data = await res.json();

      CURRENCY = data.currency || "USD";
      UNIT_PRICE = Number(data?.wax_melts?.unit_price ?? 5.00);

      const ship = data.shipping || {};
      SHIPPING = {
        label: ship.label || "Shipping & Handling",
        mode: ship.mode || "flat_plus_per_item",
        base: Number(ship.base ?? 0),
        per_item: Number(ship.per_item ?? 0),
        free_over: Number(ship.free_over ?? Infinity)
      };

      const arr = Array.isArray(data.scents) ? data.scents : [];
      SCENTS = arr.map(normalizeScent).filter(s => s.name);

      // Update UI labels to match JSON
      pricePillEl.textContent = `${money(UNIT_PRICE)} each ‚Ä¢ + shipping & handling`;
      panelMetaEl.textContent = `${money(UNIT_PRICE)} / clamshell ‚Ä¢ 6 melts ‚Ä¢ 12.6 oz`;
    }

    /***********************
     * CART PERSISTENCE
     ***********************/
    function saveCart(){
      const arr = Array.from(cart.values());
      localStorage.setItem(CART_KEY, JSON.stringify(arr));
    }

    function loadCart(){
      cart.clear();
      try{
        const raw = localStorage.getItem(CART_KEY);
        if(!raw) return;
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return;
        arr.forEach(item => {
          if(!item) return;
          const key = item.sku || item.name;
          if(!key) return;
          cart.set(key, {
            sku: item.sku || safeIdFromName(item.name),
            name: item.name || "Item",
            price: Number(item.price ?? UNIT_PRICE),
            qty: Math.max(0, Number(item.qty ?? 0))
          });
        });
      }catch(e){}
    }

    /***********************
     * SHIPPING + TOTALS
     ***********************/
    function getTotals(){
      let items = 0;
      let subtotal = 0;
      for(const it of cart.values()){
        items += it.qty;
        subtotal += it.qty * it.price;
      }

      let shipping = 0;
      if (items > 0){
        if (Number.isFinite(SHIPPING.free_over) && subtotal >= SHIPPING.free_over){
          shipping = 0;
        } else if (SHIPPING.mode === "flat_plus_per_item"){
          shipping = SHIPPING.base + (SHIPPING.per_item * items);
        } else {
          // fallback: flat base
          shipping = SHIPPING.base || 0;
        }
      }

      const total = subtotal + shipping;
      return {
        items,
        subtotal: Number(subtotal.toFixed(2)),
        shipping: Number(shipping.toFixed(2)),
        total: Number(total.toFixed(2))
      };
    }

    function updateCartBadge(items){
      if(!cartBadgeEl) return;
      if(items > 0){
        cartBadgeEl.textContent = String(items);
        cartBadgeEl.style.display = "inline-flex";
      } else {
        cartBadgeEl.textContent = "0";
        cartBadgeEl.style.display = "none";
      }
    }

    function updateCartSummary(){
      const { items, subtotal, shipping, total } = getTotals();

      cartItemsEl.textContent = items;
      cartTotalEl.textContent = money(subtotal);

      drawerItemsEl.textContent = items;
      drawerSubtotalEl.textContent = money(subtotal);
      drawerShippingEl.textContent = money(shipping);
      drawerTotalEl.textContent = money(total);

      updateCartBadge(items);
    }

    /***********************
     * CART OPERATIONS
     ***********************/
    function setQty(key, qty){
      const it = cart.get(key);
      if(!it) return;
      it.qty = Math.max(0, qty);
      if(it.qty === 0) cart.delete(key);
      saveCart();
      updateCartSummary();
      renderCartDrawer();
    }

    function addToCart(scent){
      const key = scent.sku || scent.name;
      const existing = cart.get(key);
      if(existing){
        existing.qty += 1;
      }else{
        cart.set(key, {
          sku: scent.sku || safeIdFromName(scent.name),
          name: scent.name,
          price: Number(scent.price ?? UNIT_PRICE),
          qty: 1
        });
      }
      saveCart();
      updateCartSummary();
      renderCartDrawer();
    }

    /***********************
     * RENDER MENU
     ***********************/
    function renderMenu(){
      listEl.innerHTML = "";
      SCENTS.forEach((s) => {
        const key = s.sku || s.name;
        const qty = cart.get(key)?.qty ?? 0;

        const card = document.createElement("div");
        card.className = "card";

        const left = document.createElement("div");
        left.style.minWidth = "0";
        left.innerHTML = `
          <h3 title="${s.name}">${s.name}</h3>
          <p>${s.blurb || ""}</p>
        `;

        const right = document.createElement("div");
        right.innerHTML = `
          <div class="price">${money(s.price ?? UNIT_PRICE)}</div>
          <div class="controls">
            <div class="qty" role="group" aria-label="Quantity for ${s.name}">
              <button type="button" data-action="dec" aria-label="Decrease ${s.name}">‚àí</button>
              <span data-role="qty">${qty}</span>
              <button type="button" data-action="inc" aria-label="Increase ${s.name}">+</button>
            </div>
            <button class="add" type="button" data-action="add">Add</button>
          </div>
        `;

        const qtySpan = right.querySelector('[data-role="qty"]');
        const decBtn = right.querySelector('button[data-action="dec"]');
        const incBtn = right.querySelector('button[data-action="inc"]');
        const addBtn = right.querySelector('button[data-action="add"]');

        function syncQty(){ qtySpan.textContent = cart.get(key)?.qty ?? 0; }

        decBtn.addEventListener("click", () => {
          const current = cart.get(key)?.qty ?? 0;
          if(current <= 0) return;
          setQty(key, current - 1);
          syncQty();
        });

        incBtn.addEventListener("click", () => {
          const current = cart.get(key)?.qty ?? 0;
          if(!cart.has(key)){
            cart.set(key, { sku: s.sku, name: s.name, price: s.price ?? UNIT_PRICE, qty: 0 });
          }
          setQty(key, current + 1);
          syncQty();
        });

        addBtn.addEventListener("click", () => {
          addToCart(s);
          syncQty();
          // NOTE: do not auto-open cart; user can tap üõí to view
        });

        card.appendChild(left);
        card.appendChild(right);
        listEl.appendChild(card);
      });

      updateCartSummary();
    }

    /***********************
     * RENDER CART DRAWER
     ***********************/
    function renderCartDrawer(){
      const items = Array.from(cart.values()).filter(it => it.qty > 0);

      cartListEl.innerHTML = "";
      emptyMsgEl.style.display = items.length ? "none" : "block";

      items.forEach(it => {
        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `
          <div style="min-width:0;">
            <strong title="${it.name}">${it.name}</strong>
            <small>${it.sku ? `SKU: ${it.sku}` : ""}</small>
            <div class="qty" style="margin-top:10px;" role="group" aria-label="Quantity for ${it.name}">
              <button type="button" data-act="dec" aria-label="Decrease ${it.name}">‚àí</button>
              <span data-role="q">${it.qty}</span>
              <button type="button" data-act="inc" aria-label="Increase ${it.name}">+</button>
            </div>
          </div>
          <div>
            <div class="line">${money(it.qty * it.price)}</div>
          </div>
        `;

        const key = it.sku || it.name;
        const qSpan = row.querySelector('[data-role="q"]');

        row.querySelector('[data-act="dec"]').addEventListener("click", () => {
          setQty(key, it.qty - 1);
          qSpan.textContent = cart.get(key)?.qty ?? 0;
          renderMenu(); // keep menu qty pills in sync
        });

        row.querySelector('[data-act="inc"]').addEventListener("click", () => {
          setQty(key, it.qty + 1);
          qSpan.textContent = cart.get(key)?.qty ?? (it.qty + 1);
          renderMenu(); // keep menu qty pills in sync
        });

        cartListEl.appendChild(row);
      });

      updateCartSummary();
    }

    /***********************
     * ORDER JSON
     ***********************/
    function buildOrder(){
      const { items, subtotal, shipping, total } = getTotals();

      const order = {
        order_id: genOrderId(),
        timestamp: nowISO(),
        brand: "Common Scents",
        channel: "website",
        currency: CURRENCY,
        to_email: EMAILJS.toEmail,
        customer: {
          name: (custNameEl.value || "").trim(),
          email: (custEmailEl.value || "").trim(),
          phone: (custPhoneEl.value || "").trim()
        },
        notes: (custNotesEl.value || "").trim(),
        items: Array.from(cart.values())
          .filter(it => it.qty > 0)
          .map(it => ({
            sku: it.sku || safeIdFromName(it.name),
            name: it.name,
            qty: it.qty,
            price: Number(it.price),
            line_total: Number((it.qty * it.price).toFixed(2))
          })),
        subtotal,
        shipping: {
          label: SHIPPING.label,
          mode: SHIPPING.mode,
          base: SHIPPING.base,
          per_item: SHIPPING.per_item,
          free_over: SHIPPING.free_over,
          amount: shipping
        },
        tax: 0.00,
        total
      };

      return { order, itemsCount: items };
    }

    async function copyOrderJson(){
      const { order } = buildOrder();
      const txt = JSON.stringify(order, null, 2);
      try{
        await navigator.clipboard.writeText(txt);
        setStatus("Order JSON copied to clipboard.", "ok");
      }catch(e){
        setStatus("Couldn‚Äôt copy automatically. Your browser may block clipboard.", "err");
      }
    }

    /***********************
     * EMAIL SEND (EmailJS or mailto fallback)
     ***********************/
    async function sendOrder(){
      const { order, itemsCount } = buildOrder();

      if(itemsCount <= 0){
        setStatus("Cart is empty. Add a few scents first.", "err");
        return;
      }
      if(!order.customer.name){
        setStatus("Please enter your name.", "err");
        return;
      }
      if(!order.customer.email){
        setStatus("Please enter your email.", "err");
        return;
      }

      const prettyList = order.items
        .map(i => `${i.qty} x ${i.name} (${i.sku}) = $${i.line_total.toFixed(2)}`)
        .join("\n");

      // EmailJS path (optional)
      if(EMAILJS.enabled && window.emailjs){
        try{
          emailjs.init({ publicKey: EMAILJS.publicKey });

          const params = {
            to_email: EMAILJS.toEmail,
            from_name: order.customer.name,
            from_email: order.customer.email,
            phone: order.customer.phone || "",
            notes: order.notes || "",
            order_id: order.order_id,
            timestamp: order.timestamp,
            items: prettyList,
            subtotal: `$${order.subtotal.toFixed(2)}`,
            shipping: `$${order.shipping.amount.toFixed(2)}`,
            total: `$${order.total.toFixed(2)}`,
            order_json: JSON.stringify(order, null, 2)
          };

          await emailjs.send(EMAILJS.serviceId, EMAILJS.templateId, params);
          setStatus("Order sent! We received it.", "ok");

          cart.clear();
          saveCart();
          updateCartSummary();
          renderCartDrawer();
          renderMenu();
          return;

        }catch(err){
          setStatus("EmailJS failed. Opening fallback email‚Ä¶", "err");
          // continue to fallback
        }
      }

      // Fallback: mailto (opens user's email client)
      const jsonTxt = JSON.stringify(order, null, 2);
      try{ await navigator.clipboard.writeText(jsonTxt); }catch(e){}

      const subject = encodeURIComponent(`Common Scents Order ‚Äî ${order.customer.name} ‚Äî ${order.order_id}`);
      const body = encodeURIComponent(
        `NEW ORDER\n\n` +
        `Order ID: ${order.order_id}\n` +
        `Time: ${order.timestamp}\n\n` +
        `Customer: ${order.customer.name}\n` +
        `Email: ${order.customer.email}\n` +
        `Phone: ${order.customer.phone || ""}\n\n` +
        `Items:\n${prettyList}\n\n` +
        `Subtotal: $${order.subtotal.toFixed(2)}\n` +
        `Shipping: $${order.shipping.amount.toFixed(2)}\n` +
        `Total: $${order.total.toFixed(2)}\n\n` +
        `Notes:\n${order.notes || ""}\n\n` +
        `JSON (also copied to clipboard if allowed):\n\n${jsonTxt}`
      );

      const to = encodeURIComponent(EMAILJS.toEmail || "commonscentsusa@yahoo.com");
      window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;

      setStatus("Email draft opened. JSON copied to clipboard (if allowed).", "ok");
    }

    /***********************
     * CART DRAWER OPEN/CLOSE
     ***********************/
    function openCart(){
      document.body.classList.add("cart-open");
      cartOverlay.setAttribute("aria-hidden","false");
      cartDrawer.setAttribute("aria-hidden","false");
    }
    function closeCart(){
      document.body.classList.remove("cart-open");
      cartOverlay.setAttribute("aria-hidden","true");
      cartDrawer.setAttribute("aria-hidden","true");
    }

    openCartBtn.addEventListener("click", () => {
      renderCartDrawer();
      openCart();
    });
    closeCartBtn.addEventListener("click", closeCart);
    cartOverlay.addEventListener("click", closeCart);

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeCart();
    });

    continueBtn.addEventListener("click", closeCart);
    copyJsonBtn.addEventListener("click", copyOrderJson);
    placeOrderBtn.addEventListener("click", sendOrder);

    /***********************
     * INIT
     ***********************/
    (async function init(){
      document.getElementById("navToggle").addEventListener("click", () => {
        document.body.classList.toggle("nav-open");
      });
      document.querySelectorAll(".drawer a").forEach(a => {
        a.addEventListener("click", () => document.body.classList.remove("nav-open"));
      });

      loadCart();

      try{
        await loadProducts();
      }catch(e){
        // If products.json missing, still run but show an error.
        setStatus("Could not load products.json. Check file name/location in repo.", "err");
        SCENTS = [];
      }

      // If products.json loaded but cart items were stored with old prices, update them to current UNIT_PRICE
      for (const [k, it] of cart.entries()){
        it.price = Number(UNIT_PRICE);
        cart.set(k, it);
      }
      saveCart();

      renderMenu();
      renderCartDrawer();
      updateCartSummary();

      if (SCENTS.length){
        setStatus("Orders send by email (no payment yet).");
      }
    })();
  </script>
</body>
</html>
